<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šè¯æŒ‡æ•°æ•°æ®å¯è§†åŒ– - Highchartsç‰ˆ</title>
    <!-- Highstockåº“ (åŒ…å«æ‰€æœ‰åŠŸèƒ½) -->
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: #495057;
        }

        .control-group select, .control-group input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .control-group button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .control-group button:hover {
            opacity: 0.9;
        }

        .chart-container {
            padding: 30px;
            height: 700px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .table-container {
            padding: 30px;
            max-height: 600px;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            transition: background 0.3s;
        }

        .data-table th:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .data-table th.sortable:after {
            content: ' â†•';
            color: rgba(255,255,255,0.7);
        }

        .data-table th.sort-asc:after {
            content: ' â†‘';
            color: #fff;
        }

        .data-table th.sort-desc:after {
            content: ' â†“';
            color: #fff;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            transition: background 0.3s;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table tr:nth-child(even) {
            background: #fbfbfb;
        }

        .data-table tr:nth-child(even):hover {
            background: #f0f0f0;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 50px;
            color: #dc3545;
            font-size: 1.1em;
        }

        .chart-info {
            background: #e3f2fd;
            padding: 15px 30px;
            border-left: 4px solid #2196f3;
            margin: 20px 30px;
            border-radius: 4px;
        }

        .chart-info h4 {
            color: #1976d2;
            margin-bottom: 8px;
        }

        .chart-info p {
            color: #666;
            font-size: 0.9em;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ä¸Šè¯æŒ‡æ•°æ•°æ®å¯è§†åŒ–</h1>
            <p>ä¸“ä¸šçº§äº¤äº’å¼å›¾è¡¨ä¸æ•°æ®åˆ†æ - Powered by Highcharts</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="dateRange">å¿«é€Ÿé€‰æ‹©:</label>
                <select id="dateRange">
                    <option value="30">æœ€è¿‘30å¤©</option>
                    <option value="90">æœ€è¿‘90å¤©</option>
                    <option value="180">æœ€è¿‘180å¤©</option>
                    <option value="365">æœ€è¿‘1å¹´</option>
                    <option value="1095">æœ€è¿‘3å¹´</option>
                    <option value="all" selected>å…¨éƒ¨æ•°æ®</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>æ˜¾ç¤ºæ•°æ®:</label>
                <label><input type="checkbox" id="showOpen" checked> å¼€å¸‚</label>
                <label><input type="checkbox" id="showHigh" checked> æœ€é«˜</label>
                <label><input type="checkbox" id="showLow" checked> æœ€ä½</label>
                <label><input type="checkbox" id="showClose" checked> å…³ç›˜</label>
                <label><input type="checkbox" id="showAdjClose"> è°ƒæ•´åæ”¶ç›˜ä»·</label>
            </div>

            <div class="control-group">
                <button id="resetZoom" style="background: #667eea; color: white;">é‡ç½®ç¼©æ”¾</button>
                <button id="exportChart" style="background: #28a745; color: white;">å¯¼å‡ºå›¾è¡¨</button>
            </div>
        </div>

        <div class="chart-info">
            <h4>ğŸ“Š å›¾è¡¨æ“ä½œæŒ‡å—</h4>
            <p>
                â€¢ <strong>æ—¶é—´é€‰æ‹©:</strong> ä½¿ç”¨åº•éƒ¨å¯¼èˆªå™¨é€‰æ‹©æ—¶é—´èŒƒå›´ï¼Œæˆ–æ‹–æ‹½é€‰æ‹©åŒºåŸŸ
                â€¢ <strong>ç¼©æ”¾:</strong> é¼ æ ‡æ»šè½®ç¼©æ”¾ï¼Œæ‹–æ‹½é€‰æ‹©åŒºåŸŸæ”¾å¤§
                â€¢ <strong>å¹³ç§»:</strong> æŒ‰ä½Shifté”®æ‹–æ‹½å¹³ç§»æŸ¥çœ‹
                â€¢ <strong>æ•°æ®åˆ‡æ¢:</strong> ç‚¹å‡»å›¾ä¾‹å¼€å…³ä¸åŒæ•°æ®çº¿çš„æ˜¾ç¤º
                â€¢ <strong>è¯¦ç»†ä¿¡æ¯:</strong> æ‚¬åœå›¾è¡¨æŸ¥çœ‹è¯¦ç»†æ•°å€¼
            </p>
        </div>

        <div class="stats-container" id="statsContainer">
            <!-- ç»Ÿè®¡æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="chart-container">
            <div id="stockChart"></div>
        </div>



        <div class="table-container">
            <div class="loading" id="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
            <div class="error" id="error" style="display: none;">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥CSVæ–‡ä»¶æ˜¯å¦å­˜åœ¨</div>
            <table class="data-table" id="dataTable" style="display: none;">
                <thead>
                    <tr>
                        <th class="sortable" data-column="date">æ—¥æœŸ</th>
                        <th class="sortable" data-column="open">å¼€å¸‚</th>
                        <th class="sortable" data-column="high">æœ€é«˜</th>
                        <th class="sortable" data-column="low">æœ€ä½</th>
                        <th class="sortable" data-column="close">å…³ç›˜</th>
                        <th class="sortable" data-column="adjClose">è°ƒæ•´åçš„æ”¶å¸‚ä»·</th>
                        <th class="sortable" data-column="volume">æˆäº¤é‡</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let allData = [];
        let chart = null;
        let currentSort = { column: 'date', direction: 'desc' };
        let currentRange = { min: null, max: null };

        // ç­‰å¾…åº“åŠ è½½
        function waitForLibraries() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                function check() {
                    attempts++;
                    console.log(`æ£€æŸ¥ä¾èµ–åº“... (${attempts}/${maxAttempts})`);
                    
                    if (typeof Highcharts !== 'undefined' && typeof Papa !== 'undefined') {
                        console.log('æ‰€æœ‰ä¾èµ–åº“åŠ è½½å®Œæˆ');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('ä¾èµ–åº“åŠ è½½è¶…æ—¶'));
                    } else {
                        setTimeout(check, 100);
                    }
                }
                check();
            });
        }

        // åŠ è½½CSVæ•°æ®
        async function loadData() {
            try {
                console.log('å¼€å§‹åŠ è½½CSVæ•°æ®...');
                const response = await fetch('shanghai_index.csv');
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    complete: function(results) {
                        try {
                            allData = results.data
                                .filter(row => row['æ—¥æœŸ'] && row['å¼€å¸‚'])
                                .map(row => {
                                    // è½¬æ¢æ—¥æœŸæ ¼å¼ä¸ºæ—¶é—´æˆ³
                                    const dateStr = row['æ—¥æœŸ'].replace(/å¹´|æœˆ/g, '-').replace('æ—¥', '');
                                    const timestamp = new Date(dateStr).getTime();
                                    
                                    return {
                                        date: row['æ—¥æœŸ'],
                                        timestamp: timestamp,
                                        open: parseFloat(row['å¼€å¸‚']) || 0,
                                        high: parseFloat(row['æœ€é«˜']) || 0,
                                        low: parseFloat(row['æœ€ä½']) || 0,
                                        close: parseFloat(row['å…³ç›˜']) || 0,
                                        adjClose: parseFloat(row['è°ƒæ•´åçš„æ”¶å¸‚ä»·']) || 0,
                                        volume: parseFloat(row['æˆäº¤é‡']) || 0
                                    };
                                })
                                .sort((a, b) => a.timestamp - b.timestamp);

                            console.log(`æˆåŠŸåŠ è½½ ${allData.length} æ¡æ•°æ®`);
                            
                            document.getElementById('loading').style.display = 'none';
                            document.getElementById('dataTable').style.display = 'table';
                            
                            createChart();
                            updateTable();
                            updateStats();
                        } catch (dataError) {
                            showError('æ•°æ®å¤„ç†å¤±è´¥ï¼š' + dataError.message);
                        }
                    },
                    error: function(error) {
                        showError('CSVè§£æå¤±è´¥ï¼š' + error.message);
                    }
                });
            } catch (error) {
                showError('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼š' + error.message);
            }
        }

        function showError(message) {
            console.error(message);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').innerHTML = message;
        }

        // åˆ›å»ºHighchartså›¾è¡¨
        function createChart() {
            const seriesData = [];
            
            // å‡†å¤‡æ•°æ®ç³»åˆ—
            if (document.getElementById('showOpen').checked) {
                seriesData.push({
                    name: 'å¼€å¸‚',
                    data: allData.map(item => [item.timestamp, item.open]),
                    color: '#FF6B6B',
                    yAxis: 0
                });
            }
            
            if (document.getElementById('showHigh').checked) {
                seriesData.push({
                    name: 'æœ€é«˜',
                    data: allData.map(item => [item.timestamp, item.high]),
                    color: '#4ECDC4',
                    yAxis: 0
                });
            }
            
            if (document.getElementById('showLow').checked) {
                seriesData.push({
                    name: 'æœ€ä½',
                    data: allData.map(item => [item.timestamp, item.low]),
                    color: '#45B7D1',
                    yAxis: 0
                });
            }
            
            if (document.getElementById('showClose').checked) {
                seriesData.push({
                    name: 'å…³ç›˜',
                    data: allData.map(item => [item.timestamp, item.close]),
                    color: '#96CEB4',
                    yAxis: 0
                });
            }
            
            if (document.getElementById('showAdjClose').checked) {
                seriesData.push({
                    name: 'è°ƒæ•´åæ”¶ç›˜ä»·',
                    data: allData.map(item => [item.timestamp, item.adjClose]),
                    color: '#FFEAA7',
                    yAxis: 0
                });
            }

            chart = Highcharts.stockChart('stockChart', {
                chart: {
                    backgroundColor: '#ffffff',
                    borderRadius: 8,
                    height: 650
                },
                
                title: {
                    text: 'ä¸Šè¯æŒ‡æ•°å†å²èµ°åŠ¿',
                    style: {
                        fontSize: '18px',
                        fontWeight: 'bold',
                        color: '#333'
                    }
                },
                
                subtitle: {
                    text: 'æ•°æ®æ¥æº: Yahoo Finance | æ‹–æ‹½é€‰æ‹©åŒºåŸŸç¼©æ”¾ï¼Œä½¿ç”¨åº•éƒ¨Navigatoré€‰æ‹©æ—¶é—´èŒƒå›´',
                    style: {
                        color: '#666'
                    }
                },

                navigator: {
                    enabled: true,
                    height: 50,
                    margin: 10,
                    series: {
                        data: allData.map(item => [item.timestamp, item.close]),
                        type: 'areaspline',
                        color: '#667eea',
                        fillOpacity: 0.3,
                        lineWidth: 1
                    },
                    handles: {
                        backgroundColor: '#667eea',
                        borderColor: '#4a54d1',
                        borderWidth: 1,
                        width: 8,
                        height: 16
                    },
                    outlineColor: '#667eea',
                    outlineWidth: 1,
                    maskFill: 'rgba(102, 126, 234, 0.1)',
                    xAxis: {
                        labels: {
                            style: {
                                color: '#666',
                                fontSize: '11px'
                            }
                        }
                    }
                },

                scrollbar: {
                    enabled: true,
                    height: 8,
                    barBackgroundColor: '#e9ecef',
                    barBorderRadius: 4,
                    barBorderWidth: 0,
                    buttonBackgroundColor: '#667eea',
                    buttonBorderWidth: 0,
                    buttonBorderRadius: 4,
                    trackBackgroundColor: '#f8f9fa',
                    trackBorderWidth: 1,
                    trackBorderColor: '#e9ecef',
                    trackBorderRadius: 4
                },

                rangeSelector: {
                    enabled: true,
                    selected: 5,
                    buttonTheme: {
                        fill: '#f8f9fa',
                        stroke: '#e9ecef',
                        'stroke-width': 1,
                        style: {
                            color: '#495057',
                            fontSize: '12px'
                        },
                        states: {
                            select: {
                                fill: '#667eea',
                                style: {
                                    color: 'white'
                                }
                            },
                            hover: {
                                fill: '#e3f2fd',
                                style: {
                                    color: '#495057'
                                }
                            }
                        }
                    },
                    buttons: [{
                        type: 'month',
                        count: 1,
                        text: '1m'
                    }, {
                        type: 'month',
                        count: 3,
                        text: '3m'
                    }, {
                        type: 'month',
                        count: 6,
                        text: '6m'
                    }, {
                        type: 'ytd',
                        text: 'YTD'
                    }, {
                        type: 'year',
                        count: 1,
                        text: '1y'
                    }, {
                        type: 'year',
                        count: 2,
                        text: '2y'
                    }, {
                        type: 'year',
                        count: 5,
                        text: '5y'
                    }, {
                        type: 'all',
                        text: 'All'
                    }],
                    inputEnabled: true,
                    inputDateFormat: '%Y-%m-%d',
                    inputEditDateFormat: '%Y-%m-%d'
                },
                
                xAxis: {
                    type: 'datetime',
                    title: {
                        text: 'æ—¥æœŸ'
                    },
                    events: {
                        afterSetExtremes: function(e) {
                            currentRange.min = e.min;
                            currentRange.max = e.max;
                            updateTableAndStats();
                        }
                    },
                    scrollbar: {
                        enabled: true
                    },
                    labels: {
                        format: '{value:%Y-%m-%d}'
                    }
                },
                
                yAxis: {
                    title: {
                        text: 'ä»·æ ¼',
                        style: {
                            color: '#666'
                        }
                    },
                    lineWidth: 1
                },
                
                tooltip: {
                    split: true,
                    shared: true,
                    crosshairs: true,
                    borderColor: '#667eea',
                    borderRadius: 8,
                    shadow: true,
                    style: {
                        fontSize: '12px'
                    },
                    formatter: function() {
                        let tooltip = '<b>' + Highcharts.dateFormat('%Yå¹´%mæœˆ%dæ—¥', this.x) + '</b><br/>';
                        this.points.forEach(function(point) {
                            if (point.series.name === 'æˆäº¤é‡') {
                                tooltip += '<span style="color:' + point.color + '">' + point.series.name + '</span>: <b>' + 
                                          Highcharts.numberFormat(point.y, 0) + '</b><br/>';
                            } else {
                                tooltip += '<span style="color:' + point.color + '">' + point.series.name + '</span>: <b>' + 
                                          Highcharts.numberFormat(point.y, 2) + '</b><br/>';
                            }
                        });
                        return tooltip;
                    }
                },
                
                legend: {
                    enabled: true,
                    layout: 'horizontal',
                    align: 'center',
                    verticalAlign: 'top',
                    floating: false,
                    backgroundColor: 'rgba(255,255,255,0.9)',
                    borderColor: '#e9ecef',
                    borderWidth: 1,
                    borderRadius: 4,
                    shadow: false
                },
                
                plotOptions: {
                    series: {
                        lineWidth: 2,
                        marker: {
                            enabled: false,
                            radius: 3,
                            states: {
                                hover: {
                                    enabled: true,
                                    radius: 5
                                }
                            }
                        },
                        states: {
                            hover: {
                                lineWidth: 3
                            }
                        },
                        point: {
                            events: {
                                mouseOver: function() {
                                    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ‚¬åœæ—¶çš„è‡ªå®šä¹‰é€»è¾‘
                                }
                            }
                        }
                    },
                    column: {
                        borderWidth: 0,
                        pointPadding: 0,
                        groupPadding: 0
                    }
                },
                
                series: seriesData,
                
                exporting: {
                    enabled: true,
                    buttons: {
                        contextButton: {
                            menuItems: [
                                'viewFullscreen',
                                'separator',
                                'downloadPNG',
                                'downloadJPEG',
                                'downloadPDF',
                                'downloadSVG',
                                'separator',
                                'downloadCSV',
                                'downloadXLS'
                            ]
                        }
                    }
                },
                
                credits: {
                    enabled: false
                },
                
                responsive: {
                    rules: [{
                        condition: {
                            maxWidth: 500
                        },
                        chartOptions: {
                            legend: {
                                layout: 'horizontal',
                                align: 'center',
                                verticalAlign: 'bottom'
                            }
                        }
                    }]
                }
            });
        }



        // æ›´æ–°å›¾è¡¨
        function updateChart() {
            if (!chart) return;
            
            const seriesData = [];
            
            if (document.getElementById('showOpen').checked) {
                seriesData.push({
                    name: 'å¼€å¸‚',
                    data: allData.map(item => [item.timestamp, item.open]),
                    color: '#FF6B6B',
                    yAxis: 0
                });
            }
            
            if (document.getElementById('showHigh').checked) {
                seriesData.push({
                    name: 'æœ€é«˜',
                    data: allData.map(item => [item.timestamp, item.high]),
                    color: '#4ECDC4',
                    yAxis: 0
                });
            }
            
            if (document.getElementById('showLow').checked) {
                seriesData.push({
                    name: 'æœ€ä½',
                    data: allData.map(item => [item.timestamp, item.low]),
                    color: '#45B7D1',
                    yAxis: 0
                });
            }
            
            if (document.getElementById('showClose').checked) {
                seriesData.push({
                    name: 'å…³ç›˜',
                    data: allData.map(item => [item.timestamp, item.close]),
                    color: '#96CEB4',
                    yAxis: 0
                });
            }
            
            if (document.getElementById('showAdjClose').checked) {
                seriesData.push({
                    name: 'è°ƒæ•´åæ”¶ç›˜ä»·',
                    data: allData.map(item => [item.timestamp, item.adjClose]),
                    color: '#FFEAA7',
                    yAxis: 0
                });
            }
            
            // ç§»é™¤æ‰€æœ‰ç°æœ‰ç³»åˆ—
            while(chart.series.length > 0) {
                chart.series[0].remove(false);
            }
            
            // æ·»åŠ æ–°ç³»åˆ—
            seriesData.forEach(series => {
                chart.addSeries(series, false);
            });
            
            chart.redraw();
        }

        // è·å–å½“å‰æ˜¾ç¤ºèŒƒå›´çš„æ•°æ®
        function getCurrentRangeData() {
            if (!currentRange.min || !currentRange.max) {
                return allData;
            }
            
            return allData.filter(item => 
                item.timestamp >= currentRange.min && item.timestamp <= currentRange.max
            );
        }

        // æ›´æ–°è¡¨æ ¼å’Œç»Ÿè®¡
        function updateTableAndStats() {
            const data = getCurrentRangeData();
            updateTableWithData(data);
            updateStatsWithData(data);
        }

        // ä½¿ç”¨æŒ‡å®šæ•°æ®æ›´æ–°è¡¨æ ¼
        function updateTableWithData(data) {
            const tbody = document.getElementById('tableBody');
            
            // æ’åºæ•°æ®
            const sortedData = [...data].sort((a, b) => {
                let aVal, bVal;
                
                if (currentSort.column === 'date') {
                    aVal = a.timestamp;
                    bVal = b.timestamp;
                } else {
                    aVal = a[currentSort.column];
                    bVal = b[currentSort.column];
                }
                
                if (currentSort.direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            tbody.innerHTML = sortedData.map(item => `
                <tr>
                    <td>${item.date}</td>
                    <td>${item.open.toFixed(2)}</td>
                    <td>${item.high.toFixed(2)}</td>
                    <td>${item.low.toFixed(2)}</td>
                    <td>${item.close.toFixed(2)}</td>
                    <td>${item.adjClose.toFixed(2)}</td>
                    <td>${item.volume.toLocaleString()}</td>
                </tr>
            `).join('');
        }

        // ä½¿ç”¨æŒ‡å®šæ•°æ®æ›´æ–°ç»Ÿè®¡
        function updateStatsWithData(data) {
            if (data.length === 0) return;

            const latest = data[data.length - 1];
            const earliest = data[0];
            
            const maxHigh = Math.max(...data.map(d => d.high));
            const minLow = Math.min(...data.map(d => d.low));
            const avgVolume = data.reduce((sum, d) => sum + d.volume, 0) / data.length;
            const priceChange = latest.close - earliest.close;
            const priceChangePercent = (priceChange / earliest.close * 100);

            const statsContainer = document.getElementById('statsContainer');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <h3>æœ€æ–°æ”¶ç›˜ä»·</h3>
                    <div class="value">${latest.close.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <h3>åŒºé—´ä»·æ ¼å˜åŒ–</h3>
                    <div class="value" style="color: ${priceChange >= 0 ? '#28a745' : '#dc3545'}">
                        ${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)} (${priceChangePercent >= 0 ? '+' : ''}${priceChangePercent.toFixed(2)}%)
                    </div>
                </div>
                <div class="stat-card">
                    <h3>åŒºé—´æœ€é«˜</h3>
                    <div class="value">${maxHigh.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <h3>åŒºé—´æœ€ä½</h3>
                    <div class="value">${minLow.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <h3>å¹³å‡æˆäº¤é‡</h3>
                    <div class="value">${avgVolume.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                </div>
                <div class="stat-card">
                    <h3>æ•°æ®ç‚¹æ•°</h3>
                    <div class="value">${data.length}</div>
                </div>
            `;
        }

        // æ›´æ–°æ•°æ®è¡¨
        function updateTable() {
            const data = getCurrentRangeData();
            updateTableWithData(data);
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            const data = getCurrentRangeData();
            updateStatsWithData(data);
        }

        // æ’åºåŠŸèƒ½
        function handleSort(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'desc';
            }
            
            // æ›´æ–°è¡¨å¤´æ ·å¼
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            const currentTh = document.querySelector(`th[data-column="${column}"]`);
            currentTh.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
            
            updateTable();
        }

        // åˆå§‹åŒ–åº”ç”¨
        async function initApp() {
            try {
                console.log('ç­‰å¾…ä¾èµ–åº“åŠ è½½...');
                await waitForLibraries();
                
                console.log('å¼€å§‹åŠ è½½æ•°æ®...');
                await loadData();
                
                // ç»‘å®šäº‹ä»¶
                document.getElementById('dateRange').addEventListener('change', (e) => {
                    const value = e.target.value;
                    if (value === 'all') {
                        chart.xAxis[0].setExtremes();
                    } else {
                        const days = parseInt(value);
                        const now = Date.now();
                        const startTime = now - (days * 24 * 60 * 60 * 1000);
                        chart.xAxis[0].setExtremes(startTime, now);
                    }
                });
                
                ['showOpen', 'showHigh', 'showLow', 'showClose', 'showAdjClose'].forEach(id => {
                    document.getElementById(id).addEventListener('change', updateChart);
                });
                
                document.querySelectorAll('th[data-column]').forEach(th => {
                    th.addEventListener('click', () => {
                        handleSort(th.dataset.column);
                    });
                });

                // é‡ç½®ç¼©æ”¾æŒ‰é’®
                document.getElementById('resetZoom').addEventListener('click', () => {
                    chart.xAxis[0].setExtremes();
                    console.log('å›¾è¡¨ç¼©æ”¾å·²é‡ç½®');
                });

                // å¯¼å‡ºå›¾è¡¨æŒ‰é’®
                document.getElementById('exportChart').addEventListener('click', () => {
                    chart.exportChart({
                        type: 'image/png',
                        filename: 'ä¸Šè¯æŒ‡æ•°-' + new Date().toISOString().split('T')[0]
                    });
                });


                
                console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                showError('åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼š' + error.message);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>